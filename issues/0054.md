---
title: "Verify and test compaction end-to-end"
status: open
assignee: agent
priority: high
parent: "0045"
---

# WUHU-0054: Verify and test compaction end-to-end

## Summary

Compaction has never been verified to work end-to-end. The usage gate was
removed in #5 (0.4.0), but nobody confirmed that compaction actually fires,
produces a coherent summary, and that the session continues working afterward.

## Background

WUHU-0043 documented the original bug: compaction was gated on
`message.usage` being non-nil, which was always nil for Anthropic. The gate
was removed, but the fix was mechanical â€” no integration test was added.

## What to test

Using the test harness from WUHU-0052:

1. **Compaction triggers:** Run a session with a mock LLM that produces
   enough messages to cross the compaction threshold. Verify a compaction
   entry appears in the transcript.

2. **Compaction summary is coherent:** The compaction entry should summarize
   the preceding conversation accurately. Verify the summary text is
   non-empty and the `firstKeptEntryID` / `tokensBefore` fields are sane.

3. **Session continues after compaction:** After compaction fires, enqueue
   another message. Verify the LLM receives the compacted context (not the
   full history) and produces a valid response.

4. **Multiple compactions:** Run a very long session that triggers compaction
   more than once. Verify each compaction builds on the previous one.

## Dependencies

- WUHU-0052 (test harness) must land first.
