---
title: Expose session management tools to coding sessions
status: done
priority: high
pr: https://github.com/wuhu-labs/wuhu/pull/93
merged: 2026-02-25
---

## Problem

Session management tools (create_session, fork, session_steer, session_follow_up, read_session_final_message, list_child_sessions) are currently only available in channel and forkedChannel session types. Normal coding sessions (.coding) cannot access these tools, limiting their ability to manage sub-sessions or coordinate multi-session workflows.

From `WuhuAgentTools.swift`, the current toolset logic:
```swift
switch session.type {
case .channel:
  // Management/control-plane tools are only available for channel sessions.
  tools.append(contentsOf: agentManagementTools(currentSessionID: session.id))
  // Enforce channel runtime restrictions via tool executor errors
  tools = applyChannelRestrictions(tools)

case .forkedChannel:
  // Forked channels keep the same tool schema as the parent channel
  tools.append(contentsOf: agentManagementTools(currentSessionID: session.id))

case .coding:
  break  // No management tools
}
```

## Proposed Solution

Add session management tools to normal coding sessions (.coding type). This enables:
- Coding sessions to spawn sub-sessions for parallel work
- Reading results from child sessions
- Steering/follow-up on active sessions
- Multi-session coordination patterns

Implementation:
1. Remove the `case .coding: break` restriction in `agentToolset()`
2. Add management tools to all session types: `.coding`, `.channel`, `.forkedChannel`
3. Keep channel restrictions (no bash execution) only for `.channel` type
4. Ensure all session types have full access to:
   - `create_session` - create fresh coding sessions in specified environments
   - `fork` - create child sessions inheriting conversation history
   - `list_child_sessions` - list children with status and unread state
   - `read_session_final_message` - read final assistant message from sessions
   - `session_steer` - inject messages via steer lane
   - `session_follow_up` - inject messages via follow-up lane
   - `env_*` tools - environment management

## Implementation Details

File: `Sources/WuhuCore/WuhuAgentTools.swift`

Change the `agentToolset()` switch statement:
```swift
switch session.type {
case .channel:
  tools.append(contentsOf: agentManagementTools(currentSessionID: session.id))
  tools = applyChannelRestrictions(tools)

case .forkedChannel, .coding:
  // Both forked channels and coding sessions get full management tools
  // without execution restrictions
  tools.append(contentsOf: agentManagementTools(currentSessionID: session.id))
}
```

## Acceptance Criteria

- [ ] Coding sessions (.coding) have access to all session management tools
- [ ] Channel sessions (.channel) retain their bash execution restrictions
- [ ] Forked channel sessions (.forkedChannel) continue working as before
- [ ] All existing tests pass: `swift test`
- [ ] Manual test: create a coding session and verify it can call `create_session`, `fork`, etc.

## Testing Strategy

1. Unit tests: verify tool availability per session type
2. Integration test: coding session creates child session and reads its result
3. Verify channel restrictions still work (bash disabled in .channel)

## Rationale

This change enables powerful multi-session patterns:
- A coding session can delegate work to specialized sub-sessions
- Sessions can coordinate via steer/follow-up messages
- Better support for complex workflows (e.g., one session running tests while another writes code)

The channel restrictions (no bash) remain in place for security, but coding sessions should have full capabilities including session management.
