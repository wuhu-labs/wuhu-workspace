---
title: Unify prompt/enqueue into single /v1 code path, fix tools bug in v3
status: closed
---

## Context & Intent

The server has two distinct HTTP code paths for submitting user messages to a
session. One works, one is broken. Both need to die and be replaced by a single,
correct path.

### Path 1: v2 prompt (legacy, works)

```
POST /v2/sessions/:id/prompt
  → WuhuServer.swift:169 (promptDetached)
  → WuhuService.swift:160 (promptDetached)
  → WuhuSessionRuntime.swift:97 (enqueueFollowUp)
```

This path correctly calls `setContextCwd`, `setTools`, and `setStreamFn` before
enqueueing. Client: `WuhuClient.swift:109`.

### Path 2: v3 enqueue (SSE-era, **bugged**)

```
POST /v3/sessions/:id/enqueue
  → WuhuServer.swift:265 (enqueue)
  → WuhuService.swift:323 (enqueue)
  → WuhuSessionRuntime.swift:85 (enqueue)
```

Client: `RemoteSessionSSETransport.swift:72`.

### The Bug

`WuhuService.enqueue()` (v3) does:

```swift
let runtime = runtime(for: sessionID.rawValue)
await runtime.ensureStarted()
return try await runtime.enqueue(message: message, lane: lane)
```

It **never** calls `setTools`, `setStreamFn`, or `setContextCwd`. The runtime
starts with `_tools: [AnyAgentTool] = []`. The agent loop fires an API request
with **zero tools**. The model sees no tools and falls back to narrating tool
calls as plain text. This was introduced with the SSE subscription work.

Compare with `promptDetached` (v2), which does it correctly:

```swift
let runtime = runtime(for: sessionID)
await runtime.setContextCwd(session.cwd)
await runtime.setTools(resolvedTools)
await runtime.setStreamFn(loggedStreamFn)
let userEntry = try await runtime.enqueueFollowUp(...)
```

The v3 path shipped broken. The v2 path works but is legacy. Neither should
exist after this issue. There will be one path, and it will be correct.

## Tasks

- Fix the tools/cwd/streamFn bug: the enqueue path must set up tools, cwd, and
  stream function exactly like `promptDetached` does today. This is the critical
  bug — fix it first so you have a working path before you start deleting things.
- Drop v2 entirely: remove `promptDetached` from `WuhuService`, remove the
  `/v2/sessions/:id/prompt` route from `WuhuServer`, remove the client code in
  `WuhuClient.swift` that calls it. Nuke it.
- Rename the surviving path to `/v1`: the unified endpoint is
  `POST /v1/sessions/:id/enqueue`. Not v2, not v3. `/v1`. The versioning
  restarts because the API surface is being unified.
- Update all clients: `WuhuClient`, `RemoteSessionSSETransport`, CLI entry
  points, anything that touches these endpoints. There is ONE code path.
  Everything uses it.
- Clean cutover: zero references to `/v2/`, zero references to `/v3/`, zero
  references to `promptDetached`, zero dead code.

## Files to Study

- `Sources/WuhuServer/WuhuServer.swift` — route definitions, both paths
- `Sources/WuhuCore/WuhuService.swift` — `promptDetached` (working) vs `enqueue` (broken)
- `Sources/WuhuCore/WuhuSessionRuntime.swift` — `enqueueFollowUp` vs `enqueue`
- `Sources/WuhuClient/WuhuClient.swift` — v2 client call
- `Sources/WuhuCore/RemoteSessionSSETransport.swift` — v3 client call

## Success Criteria

- `POST /v1/sessions/:id/enqueue` is the only way to submit messages
- Tools, cwd, and streamFn are correctly set up before enqueue
- `git grep -i '/v2/'` returns nothing
- `git grep -i '/v3/'` returns nothing
- `git grep 'promptDetached'` returns nothing
- The Wuhu CLI works end-to-end with the new path
- All existing tests pass
- Branch created, PR opened, PR checks passed

---

## READ THIS BEFORE YOU WRITE A SINGLE LINE

This is a clean cutover. Not a migration. Not a deprecation. Not "keep the old
one around just in case."

1. **v2 is dead.** Delete it. Every route, every service method, every client
   call. If `promptDetached` exists anywhere in the codebase when you're done,
   you have failed.

2. **v3's bug is not optional to fix.** The entire reason v3 exists is to
   replace v2, and it shipped broken — no tools, no cwd, no stream function.
   Fix it first, then rename to v1.

3. **There is ONE code path.** Not two paths that "both work." Not a
   compatibility shim. Not a redirect. One endpoint, one service method, one
   client call. If I can trace two different flows from HTTP to runtime, you
   have failed.

4. **It's called `/v1`.** Not `/v2`, not `/v3`, not `/api/v1`. The versioning
   restarts because the old versions were a mess.

5. **Zero remnants.** No commented-out code. No `// TODO: remove v2`. No unused
   imports. No orphaned test helpers. No route that 404s instead of not
   existing. Run `git grep` for every artifact of the old world and confirm
   it's gone. If I find a single reference to the old paths or a single dead
   `promptDetached` signature, you die.

Do not half-ass this. Do not leave compatibility scaffolding "for safety." The
old paths are wrong and broken. Kill them with prejudice.
