---
title: Drop AgentLoopState protocol, fix verbosity regression by sending WuhuSessionEntry over subscription wire
status: open
---

## Context & Intent

PR #56 introduced a `TranscriptItem` contract type intended to be the canonical
transcript currency across the agent loop and subscription layers. In practice it
became a lossy shim: `WuhuSessionEntry` remains the source of truth everywhere
(persistence, behavior logic, prompt preparation, compaction), and
`TranscriptItem` is derived via a destructive `wuhuToTranscriptItem()` mapping
that throws away tool args/results, compaction details, headers, session
settings, and custom entry data.

PR #57 then switched WuhuApp from the old `WuhuSessionTranscriptFormatter`
(which had rich minimal/compact/full verbosity logic operating on
`WuhuSessionEntry`) to a new `SessionSubscriptionTranscriptFormatter` operating
on the thin `TranscriptItem`. This broke the minimal/compact/full modes — all
three now render nearly identically.

Additionally, `AgentLoopState` is a protocol that requires
`transcript: [TranscriptItem]` on the behavior's state, but the generic
`AgentLoop` never reads it. The behavior itself also never reads it — everything
uses `state.entries: [WuhuSessionEntry]`. It's dead weight.

## Tasks

- Remove the `AgentLoopState` protocol. `AgentBehavior.State` should only
  require `Sendable` and `Equatable`.
- Remove `transcript: [TranscriptItem]` from `WuhuSessionLoopState`.
- Remove `TranscriptMapping.swift` (`wuhuToTranscriptItem`).
- Change the subscription wire (`SessionEvent.transcriptAppended`) to carry
  `[WuhuSessionEntry]` instead of `TranscriptPage`.
- Update `SessionInitialState` accordingly.
- In WuhuApp, replace `SessionSubscriptionTranscriptFormatter` with the existing
  `WuhuSessionTranscriptFormatter` from WuhuAPI.
- Delete `SessionSubscriptionTranscriptFormatter.swift` from WuhuApp.
- Ensure the verbosity picker (minimal/compact/full) works correctly again:
  minimal collapses tools, compact shows smart summaries, full shows tool output.
- All existing tests must pass; remove or update tests that reference the deleted
  types.

## Files to Study

- `Sources/WuhuCore/Contracts/AgentLoopContracts.swift` — `AgentLoopState` lives here
- `Sources/WuhuCore/Contracts/AgentLoop.swift` — generic loop, confirm it never reads transcript
- `Sources/WuhuCore/Contracts/TranscriptContracts.swift` — `TranscriptItem` and friends
- `Sources/WuhuCore/Contracts/SessionSubscriptionContracts.swift` — subscription wire types
- `Sources/WuhuCore/WuhuSessionBehavior.swift` — behavior state + apply
- `Sources/WuhuCore/TranscriptMapping.swift` — the lossy mapping to delete
- `Sources/WuhuCore/WuhuService.swift` — emits subscription events
- `Sources/WuhuCore/WuhuSessionRuntime.swift` — emits subscription events
- `Sources/WuhuAPI/WuhuSessionTranscriptFormatting.swift` — the formatter to restore
- `WuhuApp/Sources/SessionSubscriptionTranscriptFormatter.swift` — the formatter to delete
- `WuhuApp/Sources/SessionDetailView.swift` — view that calls the formatter
- `WuhuApp/Sources/SessionDetailFeature.swift` — feature state holding transcript

## Success Criteria

- `AgentLoopState` protocol is gone
- `TranscriptItem` family can be deleted or left inert (no production references)
- WuhuApp verbosity modes work as they did before PR #57
- `swift build` succeeds, all tests pass
- Branch created, PR opened

## Reflection

After completing, check if `TranscriptContracts.swift` is now fully unused and
can be deleted. Also check if any other types became dead as a result of this
cleanup.
