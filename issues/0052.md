---
title: "In-memory WuhuService test harness with mock LLM"
status: open
assignee: agent
priority: critical
parent: "0045"
---

# WUHU-0052: In-memory WuhuService test harness with mock LLM

## Summary

Build a test harness that exercises the full session lifecycle without a real
HTTP server or LLM. This is the most important testing investment for 0.5.0.

## Design

### Mock StreamFn

A `StreamFn` implementation that returns canned responses. Should support:

- Simple text responses ("here's my answer")
- Tool call responses (agent calls bash, read, etc.)
- Multi-turn sequences (agent calls tool, gets result, responds)
- Error simulation (rate limit, bad request, network failure)

### Test harness

```swift
struct TestHarness {
  let service: WuhuService
  let store: SQLiteSessionStore  // in-memory (:memory:)
  let runner: LocalRunner

  func createSession(mountPath: String?) async throws -> WuhuSession
  func enqueue(_ text: String, sessionID: String) async throws
  func waitForIdle(sessionID: String) async throws
  func transcript(sessionID: String) async throws -> [WuhuSessionEntry]
}
```

### Test cases to cover

1. **Basic flow:** Create session → enqueue message → LLM responds with text
   → verify transcript has user message + assistant response.

2. **Tool execution:** LLM responds with tool call → tool executes → result
   fed back → LLM responds with final text.

3. **Resume after restart:** Create session, start work, destroy service,
   create new service from same DB, enqueue new message, verify it works.

4. **Mount-free session:** Create session with no mount → enqueue message →
   verify no filesystem tools available.

5. **Mount mid-session:** Create mount-free session → mount a directory →
   verify AGENTS.md/skills emitted as transcript entries → filesystem tools
   now work.

6. **Error recovery:** LLM returns non-retryable error → session should not
   die, agent should be informed.

## Compaction testing

Compaction end-to-end testing (WUHU-0054) builds on this harness.

## Why this is critical

Today the only integration testing is manual via the CLI. Every refactor in
0.5.0 (mounts, context injection, runner abstraction) changes core session
flow. Without this harness, we're flying blind.
