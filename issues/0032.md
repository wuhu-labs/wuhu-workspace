---
title: "Investigate empty tool-call arguments (`{}`) anomaly in session 54e697f7-391a-4d1f-a67e-1be52c562312"
status: done
priority: high
---

## Context

In session `54e697f7-391a-4d1f-a67e-1be52c562312` (a **Claude Code** session for this repo), tool calls are repeatedly being recorded/emitted with **empty arguments** (`{}`) even when the tool should have non-empty inputs.

This is likely causing downstream confusion/failures (tools invoked without required parameters) and indicates either:

- the model is actually producing empty-arg tool uses due to a tool schema / prompting problem, OR
- Wuhu is losing tool-call arguments somewhere in the capture/ingestion/streaming pipeline.

This is intentionally **open-ended** and should be investigated/fixed **interactively with a human** (to inspect the session transcript, reproduce locally, and iterate on hypotheses quickly).

## Notes / Suspicious Areas

Potential causes worth checking:

1. **Tool schema definitions** (parameters/required fields) being too permissive so Claude chooses `{}`.
2. **Anthropic tool-use streaming parsing** (e.g. `input_json_delta`) not being applied, leaving the initial `input` as `{}`.
   - See `Sources/PiAI/Providers/AnthropicMessagesProvider.swift` tool-use parsing.
3. **Persistence / encoding**: `ToolCall.arguments: JSONValue` being incorrectly encoded/decoded such that non-empty arguments become `{}`.
4. **Claude Code log ingestion** (if different from the normal Anthropic API path): mapping from Claude Code events → `ToolCall` may be dropping arguments.
5. **UI rendering**: arguments exist in storage but are displayed as `{}` due to formatting/pretty-printing bugs.

## Investigation Plan (interactive)

Work with a human to:

1. Pull the session transcript via the Wuhu API / app and locate one or more tool calls that should have non-empty args.
2. For a concrete example tool call:
   - Inspect the stored `ToolCall` payload as persisted (SQLite / API JSON) to see if args are already `{}` at rest.
   - If args are missing at rest, trace backwards: provider streaming decode → runtime message assembly → session store append.
3. If args are present at rest but show as `{}` in UI, isolate the UI formatting/rendering path.
4. Attempt a minimal reproduction (if possible) by re-running a similar Claude Code tool invocation and capturing raw events.
5. Add temporary logging/instrumentation (behind a flag) at the relevant boundaries to confirm where the args are lost.

## Deliverables

- A written root-cause analysis in this issue (or linked note) explaining *where* arguments are lost and *why*.
- A fix (code change) that prevents empty-argument tool calls when arguments exist.
- If the model truly is emitting `{}` due to schema/prompting, adjust the tool schema and/or prompting to make correct args likely.

## Acceptance Criteria

- [ ] We can point to a specific boundary where tool-call arguments become `{}` (model output vs decode vs persistence vs UI)
- [ ] The behavior is fixed for a reproduction of the problem (ideally the same session flow, or a minimal reproduction)
- [ ] No regressions for normal tool calls (arguments preserved end-to-end)

## Findings (2026-02-25)

From a copied DB (`/tmp/wuhu-0032/wuhu.sqlite`) for session `54e697f7-391a-4d1f-a67e-1be52c562312`:

- Tool-call arguments are persisted as `{}` at rest (in `session_entries.payload`), not just a UI rendering issue.
- There are **11** assistant tool calls with empty arguments: **8× `write`** and **3× `bash`**.
- All 11 have `stopReason: "length"` (i.e. Anthropic `stop_reason: "max_tokens"`), and none occur on `stopReason: "toolUse"`.

Root-cause hypothesis (now covered by a unit test):

- `AnthropicMessagesProvider.mapAnthropicSSE` buffers Anthropic `input_json_delta` into a string, but only flushes it into the tool-call’s `arguments` on `content_block_stop`.
- If the stream ends with `message_stop` (or EOF) without a `content_block_stop` (seems plausible when the message stops due to `max_tokens`), the buffered tool args never get applied, leaving the initial `{}` from `content_block_start`.

Additional contributing factor (confirmed via isolated repro server + `llm_request_log_dir`):

- Wuhu wasn’t setting `RequestOptions.maxTokens` for Anthropic, so PiAI defaulted to `max_tokens: 1024`.
- With long session context (100+ messages), Anthropic frequently returned `stopReason: "length"` while starting a `tool_call`, yielding `{}` args (missing required keys).
- After setting a higher Anthropic default in `WuhuSessionBehavior` (`maxTokens = 4096`), the same session was able to produce a non-empty `write` tool call and complete successfully in the isolated repro.
