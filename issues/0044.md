---
title: "Add join_sessions tool for parallel child session orchestration"
status: done
assignee: agent
priority: high
---

# WUHU-0044: Add `join_sessions` tool for parallel child session orchestration

## Summary

Add a `join_sessions` agent tool that blocks until all specified child sessions
reach a terminal state (`idle` or `stopped`), then returns their final statuses
and messages in a single tool result. This is the multi-session equivalent of
`Promise.all` / Swift `TaskGroup` — fan out with `create_session`/`fork`, fan
in with `join_sessions`.

## Motivation

The current parallel session orchestration pattern is fragile and expensive:

1. Dispatch N child sessions via `create_session`
2. Start a 30-minute `async_bash sleep` timer
3. When it fires, call `list_child_sessions` once
4. Check which are done, read their final messages individually
5. If some are still running, set another timer and repeat

Problems:
- Each timer/check cycle adds 2+ messages to context (~$0.05–0.10 per cycle)
- Agent must manually juggle timer IDs and remember pending sessions
- Degenerate polling loops have cost $70+ and bricked sessions (WUHU-0043
  documents one such incident)
- The multi-session skill doc warns in bold to NEVER poll in a loop, but this
  is a footgun that relies on the agent following instructions perfectly

`join_sessions` moves the wait loop server-side (SQLite polling with
exponential backoff), so there is **zero context growth** while waiting.

## Design

### Tool Schema

```json
{
  "name": "join_sessions",
  "parameters": {
    "type": "object",
    "properties": {
      "sessionIDs": {
        "type": "array",
        "items": { "type": "string" },
        "description": "Session IDs to wait for. All must be child sessions of the current session."
      },
      "timeout": {
        "type": "number",
        "description": "Maximum seconds to wait (optional, default: 3600)."
      }
    },
    "required": ["sessionIDs"],
    "additionalProperties": false
  }
}
```

### Behavior

- Validates all IDs are children of the calling session
- Polls `listChildSessions` server-side with exponential backoff (5s → 60s)
- When a session becomes `idle` or `stopped`, collects its final message
- Marks final messages as read on the parent's behalf
- Returns all results when all sessions finish, or partial results on timeout
- Respects `Task.checkCancellation()` for clean abort

### Return Shape

```
All 3 sessions completed.

✅ abc-123 [idle]
✅ def-456 [idle]
✅ ghi-789 [idle]

--- abc-123 ---
Successfully implemented X. PR #42 open, CI green.

--- def-456 ---
Implemented Y. PR #43 open, all tests passing.

--- ghi-789 ---
Finished Z. PR #44 merged.
```

### Parallel Dispatch Pattern (Before → After)

Before (8+ tool calls, context bloat):
```
create_session A → idA
create_session B → idB
async_bash "sleep 1800"
list_child_sessions
read_session_final_message idA
async_bash "sleep 1800"
list_child_sessions
read_session_final_message idB
```

After (3 tool calls, zero bloat):
```
create_session A → idA
create_session B → idB
join_sessions [idA, idB]
```

## Implementation

### Code Changes

| File | Change |
|------|--------|
| `WuhuAgentTools.swift` | Add `joinSessionsTool()` to `agentManagementTools()` |
| `WuhuAgentTools.swift` | Add `WuhuAgentToolNames.joinSessions` |
| `ToolArgs.swift` | Add `requireStringArray` if not already present |
| `.wuhu/skills/multi-session-delivery/SKILL.md` | Update dispatch pattern |

### Testing

- Unit tests for the tool (mock store, verify polling, timeout, validation)
- Integration test: build wuhu, start test server, use CLI to drive a session
  that spawns child sessions (sleeping) and joins them

## Affected Components

- `wuhu-core`: `WuhuAgentTools.swift`, `ToolArgs.swift`
- Skill: `multi-session-delivery/SKILL.md`
