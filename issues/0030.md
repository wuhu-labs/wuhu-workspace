---
title: "Surface steer vs follow-up mode + show both user queues in Session UI"
status: done
priority: high
---

## Context

Wuhu supports two user-input queue lanes:

- `UserQueueLane.steer`
- `UserQueueLane.followUp`

In WuhuMVPApp, `SessionFeature` already tracks both backfills (`state.steer`, `state.followUp`), but:

1) The UI doesn’t clearly expose which lane the user is enqueueing into (steer vs follow-up).
2) The UI doesn’t show the *current pending items* in both queues.
3) Incremental `.userQueue(cursor:entries:)` subscription events currently only append to `journal` and do not keep `pending` in sync (and lane routing is based on `entries.first?.lane`, which can mis-route if a batch ever contains mixed lanes).

Also, the app’s enqueue call currently defaults to follow-up because `APIClient.enqueue(...)` does not expose the lane parameter (and `WuhuClient.enqueue` defaults `lane: .followUp`).

## Requirements

### 1) UI: clearly surface “steer” vs “follow-up” enqueue mode

In `SessionThreadView` (message input area), add a control that shows and lets the user choose the lane:

- A segmented control (`Steer` | `Follow-up`), a menu, or another compact control suitable for the chat composer.
- The currently selected mode must be obvious at a glance.

### 2) Enqueue must respect the selected lane

Plumb the selected lane through:

- `SessionThreadView` → `SessionFeature.Action.sendMessage` (or a new action that includes lane)
- `APIClient.enqueue` → `WuhuClient.enqueue(sessionID:input:user:lane:)`

So that:

- Choosing **Steer** enqueues with `lane=steer`
- Choosing **Follow-up** enqueues with `lane=followUp`

### 3) UI: show current pending items in *both* queues

Add UI in session detail that displays (at minimum):

- A “Steer Queue” section with a count + list of current `pending` items
- A “Follow-up Queue” section with a count + list of current `pending` items

Placement is flexible (e.g., above the transcript, in a collapsible sidebar section, or below the status bar), but it must be visible and update live.

### 4) Keep queue state correct as subscription events arrive

Update `SessionFeature.applyEvent(_:to:)` so that `.userQueue(cursor:entries:)` updates the correct lane(s) and keeps `pending` accurate.

Specifically:

- Do not route the entire batch based only on `entries.first?.lane`.
  - Split entries by lane (or otherwise process each entry’s `lane` value) and apply to the correct backfill.
- Update both `journal` *and* `pending` when journal entries arrive:
  - `.enqueued` → insert pending item
  - `.canceled` → remove pending item by id
  - `.materialized` → remove pending item by id

(Goal: UI can reliably display “current items in both queues”.)

## Files to Change

- `WuhuMVPApp/Sources/SessionFeature.swift`
  - Add state for selected enqueue mode (lane)
  - Update actions/effects to enqueue with the chosen lane
  - Fix `.userQueue` event handling to update both `journal` and `pending` correctly per lane
  - Add UI for lane selection + queue display
- `WuhuMVPApp/Sources/APIClient.swift`
  - Extend `enqueue` to accept a lane (and forward it)
- `Sources/WuhuClient/WuhuClient.swift`
  - Likely no functional change required, but ensure caller uses `lane:` explicitly (do not rely on default)

## Acceptance Criteria

- [ ] Session UI clearly indicates whether the next message will be enqueued as **Steer** or **Follow-up**
- [ ] User can switch modes, and enqueue uses the selected lane
- [ ] Session UI shows current pending items for **both** queues (steer + follow-up)
- [ ] Pending items update correctly as `.userQueue` subscription events arrive (enqueue/cancel/materialize)
- [ ] Build passes:
  - `xcodebuild build -project WuhuMVPApp/WuhuMVPApp.xcodeproj -scheme WuhuMVPApp -destination 'platform=macOS' -quiet`
