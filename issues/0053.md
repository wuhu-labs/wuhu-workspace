---
title: "Database migration from 0.4.0 to 0.5.0 schema"
status: done
assignee: agent
priority: high
parent: "0045"
---

# WUHU-0053: Database migration from 0.4.0 to 0.5.0 schema

## Summary

Clean SQLite migration from the 0.4.0 schema to 0.5.0. Uses GRDB's migration
infrastructure.

## Schema changes

### New tables

**`mount_templates`** (replaces `environments`)
```sql
CREATE TABLE mount_templates (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  type TEXT NOT NULL,          -- 'folder' (future: 'zfs_dataset', etc.)
  templatePath TEXT NOT NULL,
  workspacesPath TEXT NOT NULL,
  startupScript TEXT,
  createdAt DATETIME NOT NULL,
  updatedAt DATETIME NOT NULL
);
```

**`mounts`** (new — tracks every mount created)
```sql
CREATE TABLE mounts (
  id TEXT PRIMARY KEY,
  sessionID TEXT NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  path TEXT NOT NULL,
  mountTemplateID TEXT REFERENCES mount_templates(id),
  isPrimary BOOLEAN NOT NULL DEFAULT 1,
  createdAt DATETIME NOT NULL
);
CREATE INDEX mounts_on_sessionID ON mounts(sessionID);
```

### Dropped tables

- `environments` — data migrated to `mount_templates`
- `session_child_status` — channel feature removed

### Modified: `sessions`

Drop columns:
- `sessionType` (all sessions are coding)
- `displayStartEntryID` (channel-only feature)
- `runnerName` (WebSocket runner removed)
- `environmentID`
- `environmentName`
- `environmentType`
- `environmentPath`
- `environmentTemplatePath`
- `environmentStartupScript`

Make nullable:
- `cwd` (nil for mount-free sessions)

### Data migration

1. For each row in `environments` with `type = 'folder-template'`:
   insert into `mount_templates` with fields mapped.
2. For each row in `environments` with `type = 'local'`: skip (no template
   needed, these become direct mounts).
3. For each session: create a row in `mounts` from the session's
   `environment*` columns, with `isPrimary = true`.
4. Drop old columns from `sessions`.
5. Drop `environments` and `session_child_status` tables.

## Notes

- SQLite 3.35+ required for `ALTER TABLE DROP COLUMN` (system has 3.51).
- GRDB migrations are sequential and idempotent.
- The migration should be tested with a copy of the production database
  (~30MB, 95 sessions) before shipping.
