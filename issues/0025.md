---
title: "Wire streaming deltas through subscription hub"
status: open
priority: high
---

## Context

The agent loop contract (`AgentLoopEvent`) already has clean streaming brackets:
- `.streamBegan`
- `.streamDelta(StreamAction)` (with `inflight` accumulation in `observe()`)
- `.streamEnded`

The ContractAgentLoop doc (line 83) states: "The session layer consumes the
loop's event stream, maps committed actions to versioned patches, and
**forwards stream deltas as ephemeral events**."

The ContractSession doc (lines 119-129) describes the target subscribe flow
where `text.delta` events are streamed in real-time between `message.start`
and `message.end` brackets, with mid-flight content never part of the stable
patch.

Currently `WuhuSessionRuntime.handleLoopEvent` only publishes stream deltas to
`eventHub` (the `/follow` hub, `WuhuLiveEventHub`). It never touches
`subscriptionHub` (`WuhuSessionSubscriptionHub`). The wiring was never
completed.

This means the `/subscribe` endpoint (used by apps for persistent, gap-free
observation) has no text streaming — clients only see complete entries via
`transcriptAppended` after inference finishes.

## Tasks

- Add streaming cases to `SessionEvent`: `.streamBegan`, `.streamDelta(String)`,
  `.streamEnded`
- In `WuhuSessionRuntime.handleLoopEvent`, publish these to `subscriptionHub`
  alongside `eventHub` for the `.streamBegan`, `.streamDelta`, `.streamEnded`
  cases
- `RemoteSessionSSETransport` already passes through all `SessionEvent` —
  should need no changes
- Update MVPApp `SessionFeature` (and channel observation in `AppFeature`) to
  handle the new events and drive streaming text UI
- Consider the reconnection case: when a client reconnects mid-stream, the
  `inflight` field from `observe()` should seed the initial state so the
  client can resume rendering partial text

## Files to study

- `Sources/WuhuCore/Contracts/AgentLoopContracts.swift` — `AgentLoopEvent`,
  `AgentLoopObservation` with `inflight` field
- `Sources/WuhuCore/Contracts/SessionSubscriptionContracts.swift` — `SessionEvent`
  enum that needs new cases
- `Sources/WuhuCore/WuhuSessionRuntime.swift:164-251` — `handleLoopEvent` where
  stream deltas are published to eventHub but not subscriptionHub
- `Sources/WuhuCore/WuhuSessionSubscriptionHub.swift` — the subscription hub
- `Sources/WuhuCore/WuhuCore.docc/Design/ContractSession.md:119-129` — target
  design for streaming in subscribe flow
- `Sources/WuhuCore/WuhuCore.docc/Design/ContractAgentLoop.md:57-83` — streaming
  brackets and layering
