---
title: "Workspace API v2: richer types and query endpoints"
status: open
assignee: agent
priority: medium
---

# WUHU-0042: Workspace API v2: richer types and query endpoints

## Background

WUHU-0041 extracted the workspace engine into `wuhu-workspace-engine`. A
follow-up integration (Option A) replaced `WuhuWorkspaceDocsStore` in
`wuhu` with the engine, but kept the existing wire types
(`WuhuWorkspaceDocSummary`, `WuhuWorkspaceDoc`) and the app unchanged.

This issue is "Option B" — evolve the API surface and app to take full
advantage of the engine.

## Problem

The current API returns raw `[String: JSONValue]` frontmatter and the app
manually parses it into `MockIssue` / `MockDoc` types:

- `MockIssue.from(summary)` hand-extracts `status`, `priority`, `assignee`
  from the frontmatter JSON dictionary.
- The app splits docs vs. issues by checking `path.hasPrefix("issues/")`.
- There are no query endpoints — the client fetches all docs and filters
  client-side.

This is fragile, duplicates logic the engine already handles, and prevents
the server from doing efficient queries.

## Goals

### 1. Richer API types

Replace or augment `WuhuWorkspaceDocSummary` with a type that exposes:

- `path: String`
- `kind: String` (from the engine, not inferred from path)
- `title: String?`
- `properties: [String: String]` (typed properties from the engine)

The app should receive structured data and not need to parse frontmatter
dictionaries. The `MockIssue.from(summary)` conversion should become
trivial or unnecessary.

### 2. Query endpoints

Add server endpoints that expose the engine's query capabilities:

- `GET /v1/workspace/documents?kind=issue` — filter by kind
- `GET /v1/workspace/documents?kind=issue&status=open` — filter by
  kind and properties
- `POST /v1/workspace/query` with a SQL body — for database views and
  ad-hoc queries, returns `[[String: String]]`

### 3. Update the app

- Remove `MockIssue.from(summary)` frontmatter parsing — use the new
  structured types directly.
- Remove the `path.hasPrefix("issues/")` hack — use `kind` from the API.
- Fetch issues via `?kind=issue` instead of fetching all docs and filtering.

### 4. Add `assignee` to `wuhu.yml`

The built-in `issue` kind only has `status` and `priority` in its extension
table. Add a `wuhu.yml` to `~/.wuhu/workspace/` that extends the issue kind
with `assignee`:

```yaml
kinds:
  - kind: issue
    properties:
      - status
      - priority
      - assignee
```

### 5. Database views (stretch)

Parse `database-view` Markdown blocks and expose them via:

- `GET /v1/workspace/views` — list available views
- `GET /v1/workspace/views/:id` — execute a view's query and return results

This enables the Notion-style database view rendering in the app.

## Out of scope

- Changing `WorkspaceContracts` to use typed values instead of `[String: String]`
  (the string representation works fine for SQLite queries and rendering)
- Multi-valued properties / array support
- Real-time push updates (WebSocket observation of engine changes)

## Validation

- [ ] New API types are used by the app — no more `MockIssue.from(summary)`
      frontmatter parsing
- [ ] `GET /v1/workspace/documents?kind=issue` returns only issues
- [ ] App fetches issues via kind filter, not path prefix
- [ ] `wuhu.yml` in workspace with `assignee` on issues
- [ ] `swift build` and `swift test` pass
- [ ] App builds on macOS and iOS
