---
title: "Agent tools misalignment: no direct session creation, fork breaks prefix cache"
status: closed
priority: medium
---

## Context & Intent

Tracking gaps between the current `WuhuAgentTools` implementation and intended design.

## 1. No direct session creation tool

`fork` is the only way a channel agent can create a coding session. It always
copies the parent transcript up to the fork point. There's no tool to spin up a
fresh, blank coding session — e.g. "create a coding session in environment X
with this task." This is needed for subagent-style dispatch where history
inheritance is unwanted.

A direct creation tool would also make the env CRUD tools useful — right now
the channel agent can manage environments but has no way to deploy sessions
into them (`fork` hardcodes `parent.environmentID`). With direct creation
taking an `environmentID` param, the env tools become the setup step for
dispatching work into different environments.

## 2. Fork breaks LLM prefix cache

Fork copies the parent transcript but swaps the toolset (channel tools →
coding tools). Since tools sit at the top of the prompt (system/tools block),
changing them invalidates the entire KV/prefix cache for the copied history.
The child pays full prefill cost on content that was already cached in the
parent.

Fix: forked coding sessions should preserve the parent's toolset in the prefix
so the cached KV entries carry over. This implies a distinct session type —
e.g. `.channel(forked: true)` or a third type `.forkedChannel` — where the
child keeps the channel tool schema in the prompt but has coding-level
execution permissions. Alternatively, the toolset could be appended at the end
rather than prepended, but that depends on provider support.
