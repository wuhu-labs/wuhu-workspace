---
title: Dynamic environments
status: open
---

## Context & Intent

Environments are currently defined in a static config file and loaded once at
server startup. Adding or changing an environment requires editing the file and
restarting the server. This blocks multi-repo workflows, CLI-driven setup, and
any future where the assistant agent manages environments on behalf of users.

We want environments to be a runtime-managed resource: created, listed,
updated, and deleted via API and CLI, persisted in SQLite. The static config
file should stop carrying environment definitions entirely — no migration
path, no backward compat, clean break.

The existing `WuhuEnvironment` struct becomes a snapshot (already is), and a
new `environments` table in SQLite holds the canonical definitions. Sessions
reference environments by UUID.

Future context: environments will eventually bind to runners by tags, support
multi-machine setups, and the assistant agent will create them via CLI tools.
Don't over-design for that, but don't make choices that prevent it.

We're also renaming the instantiated session path concept: the environment
definition is the spec, the concrete instance a session runs in is the
"workspace."

## Tasks

- Add an `environments` table to SQLite. Columns: `id` (UUID, primary key),
  `name` (text, unique), `type` (text — `local` or `folder-template`),
  `path` (text), `templatePath` (text, nullable), `startupScript` (text,
  nullable), `createdAt`, `updatedAt`. New migration.
- CRUD operations on `SQLiteSessionStore` (or a new store actor if that's
  cleaner): create, get, list, update, delete environments.
- API endpoints for environment CRUD. REST on the existing Hummingbird server.
- CLI subcommands: `wuhu env create`, `wuhu env list`, `wuhu env get`,
  `wuhu env update`, `wuhu env delete`. Thin wrappers over the API.
- Session creation takes an environment UUID instead of a `WuhuEnvironment`
  value. Server looks up the definition from the DB, snapshots it into the
  session. The session's concrete working path is its "workspace."
- Remove the code path that reads environment definitions from the static
  config file. Environments only come from the database. The config file
  keeps LLM credentials and server settings (port, DB path), nothing else.
- `wuhu env list` and `wuhu env get` should accept both UUID and name for
  human convenience, but the system keys on UUID internally.

## Review Checklist

After implementation, a reviewer should check for:

- **No backward-compat shims.** There should be no code that falls back to
  reading environments from config if the DB is empty, no "legacy" code paths,
  no migration from config to DB. Clean break.
- **No over-defensive code.** Watch for: unnecessary nil-checks on non-optional
  fields, try/catch around operations that can't fail, guard clauses protecting
  against impossible states, `reserveCapacity` on small collections, hand-rolled
  escaping/encoding where Codable suffices.
- **No speculative features.** Runner binding, tags, groups, multi-machine
  support — none of that belongs in this PR. The environment definition is
  name + type + path + template + startup script. That's it.
- **Clean CLI output.** `wuhu env list` should print a readable table with
  ID and name. No JSON dumps unless `--json` is passed.

## Files to Study

- `Sources/WuhuAPI/WuhuEnvironment.swift` — existing environment types
- `Sources/WuhuCore/SQLiteSessionStore.swift` — session creation, migration
  patterns, how environments are currently consumed
- `Sources/WuhuCore/WuhuService.swift` — where config is currently read
- `Sources/wuhu/main.swift` — CLI entry point and subcommand structure
- `Sources/WuhuServer/` — existing HTTP routes for reference

## Success Criteria

- `wuhu env create --name my-repo --type local --path /path/to/repo` works
- `wuhu env list` shows environments from the database
- Session creation with an environment UUID works end-to-end
- No environment-related config in the server config file
- `swift build` succeeds
- `swift test` passes
