---
title: Channel agents
status: open
---

## Context & Intent

Wuhu currently has coding agent sessions. We're adding a second tier: channel
agents. Both are powered by the same session infrastructure, same tool set in
the LLM message (for cache efficiency), but with different runtime behavior.

Channels are the user's primary interface for interacting with agents
conversationally. A channel agent schedules work, delegates to coding sessions
via fork, reads/writes workspace files, and manages environments. It does NOT
execute bash directly — bash calls from a channel session return an error
guiding the agent to fork instead.

Each channel is backed by a session. One-to-one private channels (DM with
your assistant) are the starting point. No sub-threads for MVP.

## Tasks

### Channel as session

- A channel is a session with a channel-specific system prompt. The system
  prompt should instruct the agent: "You are a channel agent. You schedule
  work by forking. You do not execute code directly. When the user asks a
  question or addresses you with @channel, respond. Otherwise, ask for
  confirmation before acting."
- Channels appear in the API alongside sessions but are distinguishable
  (add a session type or tag — channel vs coding).
- Channel sessions use the same tool set as coding sessions (for LLM prefix
  cache). Bash tool calls from a channel session return an error:
  "Bash execution is not available in channel sessions. Use the fork tool
  to delegate work to a coding session."

### Fork tool

- New tool: `fork`. Takes a string argument (the child's task description).
- Fork creates a new coding session with `parentSessionID` pointing to the
  channel session. The child session inherits the full conversation history
  up to and including the fork call.
- The child session is a regular coding session — bash works, all tools work.
  `send_message` is disabled (errors if called) to prevent the child from
  trying to reply in the channel.
- In the UI, the child session hides all entries before the fork point. The
  user sees it pick up from the fork.
- The parent (channel) receives a notification when the child session goes
  idle. This notification includes the child's final assistant message
  (the last message with no pending tool calls).

### Session management tools for channel agents

- Tool to list sessions the channel agent created, with status (running,
  idle, stopped) and whether there are unread final messages. Think
  notification dots — the channel agent should not forget about sessions
  after compaction.
- Tool to read a session's final message (the last assistant message before
  idle).
- Channel agents can reference sessions in their messages using the
  `session://<session-id>` scheme. The app renders these as clickable links.

### Steer and follow-up into child sessions

- Channel agents can send steer messages into child coding sessions (inject
  with the next tool result batch).
- Channel agents can send follow-up messages into child coding sessions
  (delivered at turn boundary).
- This reuses the existing steer/follow-up queue infrastructure.

### Environment tools

- Channel agents have access to environment CRUD tools: create, list, get,
  update, delete.
- For local envs this is straightforward.
- For folder-template envs, the workflow is: channel agent creates a coding
  session at a specific path, asks it to initialize the folder, then creates
  an env pointing at the result. This requires a new session creation option
  to start from a path directly (not from an env ID).

### Behavior (no-mention rule)

- If the user sends a message that doesn't @mention the channel or ask a
  direct question, the channel agent should ask for confirmation before
  acting. This is enforced via system prompt, not runtime logic.
- Direct @channel mentions or clear questions get immediate responses.

## Files to Study

- `Sources/WuhuCore/SQLiteSessionStore.swift` — session creation, entry model
- `Sources/WuhuCore/WuhuSessionBehavior.swift` — behavior protocol
- `Sources/WuhuCore/WuhuTools.swift` — existing tool definitions
- `Sources/WuhuCore/CodingAgentTools.swift` — existing tool implementations
- `Sources/WuhuAPI/WuhuSession.swift` — session model

## Review Checklist

- Tool set in the LLM messages is identical for channel and coding sessions.
  Behavioral differences are enforced by runtime error responses, not by
  removing tools from the schema.
- No backward-compat shims. This is a new feature.
- Fork creates a real session with its own ID, visible in the sessions list.
- No sub-threads, no channel-level agents watching all messages, no debounce
  logic. Keep it simple.

## Success Criteria

- Can create a channel, chat with the agent, fork a coding session, and see
  the result come back.
- Child sessions appear in the sessions list, linked to parent channel.
- Channel agent can list its child sessions and read their final messages.
- `session://` links render in the app.
- `swift build` succeeds, `swift test` passes.
