---
title: Proper task hierarchy for agentic loop
status: open
---

On iOS app, I noticed that, once we leave the chat streaming page, the whole
execution is dropped. This screams a typical issue of agentic loop not being
properly detached from the request/response task context and gets cancelled when
the POST request for prompt is dropped.

This is a very very wrong implementation. Agentic loop can take hours to finish,
and thus the correct way is to “enqueue” the prompt to the actor, then call in a
“detached” task (not necessarily means Task.detached) to start the agentic loop,
if one is not already running for this session.

You should respect structured concurrency for this. One way I can imagine is to
have a long lived task for agentic loops for all sessions. Under it are child
tasks for each session. Prompt should append the data, and notify the master
loop manager to process it. The master manager should start a new child task or
ping the existing one (ping might be unnecessary as the existing one should pick
it up by the end of it). Thats just a sketch, you need to design this yourself,
carefully, and document it in DocC afterwards. In any case, correct structured
concurrency is key.

On surface side. The current client CLI supports prompt that is not detached.
Even in this case, you must update the code to run via the prompt-as-queue
codepath, and then observe the session. Do not split path here by reusing old
logic. Drop them! Make this POST once, optionally stream next via separate
channel the only code path.

Add tests where you see fit.
