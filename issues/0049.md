---
title: "Runner abstraction with RunnerID and in-process LocalRunner"
status: open
assignee: agent
priority: high
parent: "0045"
---

# WUHU-0049: Runner abstraction with RunnerID and in-process LocalRunner

## Summary

Define a runner protocol and `RunnerID` enum. All tool execution goes through
a runner. For 0.5.0 the only implementation is `LocalRunner` using in-process
calls — no WebSocket, no serialization.

## Design

### RunnerID

```swift
public enum RunnerID: Sendable, Hashable, Codable {
  case local
  // future: case remote(name: String)
}
```

Used everywhere a runner is referenced: mounts, tool dispatch, session config.

### Runner protocol

```swift
protocol Runner: Sendable {
  var id: RunnerID { get }
  func resolveMount(sessionID: String, template: WuhuMountTemplate) async throws -> WuhuMount
  func executeTool(sessionID: String, mountID: String, toolName: String, args: JSONValue) async throws -> AgentToolResult
}
```

### LocalRunner

The single implementation for 0.5.0. Does what the server currently does
inline — resolves paths, executes bash via Process, runs read/write/edit
directly. No IPC, no serialization overhead.

This replaces the inline tool execution in `WuhuService.enqueue()` where
tools are constructed ad-hoc each time.

## Code to delete

- `Sources/WuhuRunner/` — the entire runner target (WebSocket client/server,
  message loop, `SQLiteRunnerStore`)
- `Sources/WuhuServer/RunnerConnection.swift`
- `Sources/WuhuServer/RunnerRegistry.swift` (or the WebSocket parts of it)
- `Sources/WuhuServer/WuhuRemoteTools.swift`
- Runner WebSocket route (`/v1/runners/ws`)
- Runner config in `WuhuServerConfig` (`runners`, `connectTo`)
- `WuhuRunnerMessage` protocol (resolve/register/tool request-response)
- `~/.wuhu/runner.sqlite` becomes unused

## Code to keep (relocated)

- `WuhuWorkspaceManager` — mount materialization logic moves into LocalRunner
- Tool construction (`codingAgentTools`) — called by LocalRunner
- Environment resolution logic — becomes `LocalRunner.resolveMount`

## Testing

`LocalRunner` is directly testable — no WebSocket setup needed. Tests can
create a runner, resolve a mount to a temp directory, execute tools, and
verify results.
