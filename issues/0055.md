---
title: "v6 migration drops all sessions instead of migrating them"
status: done
priority: high
---

## v6 migration drops all sessions instead of migrating them

The `wuhu_v6_mounts` migration in `SQLiteSessionStore` does a hard
`DROP TABLE` on `sessions`, `session_entries`, and all related tables, then
recreates them from scratch. This means upgrading a server from pre-0.5.0 to
0.5.0 wipes every existing session and its transcript.

### Current behavior

```swift
// Sources/WuhuCore/SQLiteSessionStore.swift
migrator.registerMigration("wuhu_v6_mounts") { db in
  // Hard reset: this repo intentionally does not migrate older schemas.
  // Drop all old tables and recreate from scratch.
  try db.execute(sql: "DROP TABLE IF EXISTS sessions")
  try db.execute(sql: "DROP TABLE IF EXISTS session_entries")
  ...
}
```

### Expected behavior

The migration should preserve existing sessions and entries. The schema diff
between v5 and v6 is straightforward — the sessions table needs columns
dropped and one made nullable:

**Columns to drop from `sessions`:**
- `environmentName`, `environmentType`, `environmentPath`,
  `environmentTemplatePath`, `environmentStartupScript`
- `runnerName`
- `sessionType`
- `displayStartEntryID`
- `environmentID`

**Columns to alter:**
- `cwd`: change from `NOT NULL` to nullable

**Tables to drop entirely (no longer used):**
- `environments`
- `session_child_status`

**Tables to create:**
- `mount_templates`
- `mounts`

### Suggested approach

Since SQLite doesn't support `DROP COLUMN` before 3.35.0 (and GRDB's
migration DSL doesn't expose it), the standard pattern is:

1. Rename `sessions` → `sessions_old`
2. Create new `sessions` table with the v6 schema
3. `INSERT INTO sessions SELECT <mapped columns> FROM sessions_old`
   - `cwd` can keep its existing value (was always populated)
   - Dropped columns are simply not copied
4. Recreate `session_entries` foreign keys (or just keep them — the IDs
   haven't changed)
5. Drop `sessions_old`, `environments`, `session_child_status`
6. Create `mount_templates` and `mounts`

`session_entries`, `tool_call_status`, and the queue tables don't need schema
changes — they just need their data preserved.

### Impact

Anyone running wuhu-core as a persistent server (i.e., us) loses all session
history on upgrade. This was hit when testing the wuhu-app mounts adaptation
(PR wuhu-app#17).
