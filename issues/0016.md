---
title: Clean up unnecessary defensive code in WuhuSkills
status: closed
---

## Context

`WuhuSkills` and `WuhuSkillsLoader` were added in the skills PR. The core
logic is fine, but there's a layer of speculative defensive code that adds
complexity for scenarios that don't exist.

## Tasks

- **Remove `parseFromSystemPrompt` fallback** — This is a hand-rolled XML
  parser that extracts skills back out of the system prompt string for "older
  sessions." Skills were just introduced; there are no older sessions. Kill the
  entire method and the `extractXmlTag` / `unescapeXml` helpers it uses.

- **Remove `extract(from:)` dual path** — Currently tries header metadata
  first, falls back to the XML parser above. With the parser gone, `extract`
  should just decode from metadata. One path.

- **Remove the `contains("<available_skills>")` guard in `createSession`** —
  The caller never pre-bakes skills into the system prompt. This guard protects
  against a situation that can't happen. Just append unconditionally (when
  skills are non-empty).

- **Remove XML escaping in `promptSection`** — Skill names come from local
  YAML frontmatter files. They won't contain `&` or `<`. The `escapeXml`
  helper and its usage in `promptSection` can go. Keep the XML-like tags as
  plain string interpolation.

- **Remove gratuitous `reserveCapacity` calls** — Scattered across
  `promptSection`, `decodeFromHeaderMetadata`, `loadFromDir`, `scanForSkills`.
  These arrays will have single-digit element counts. Let the allocator do its
  job.

## Files

- `Sources/WuhuAPI/WuhuSkill.swift`
- `Sources/WuhuCore/SQLiteSessionStore.swift` (line 34, the contains guard)

## Success Criteria

- `parseFromSystemPrompt`, `extractXmlTag`, `unescapeXml`, `escapeXml` deleted
- `extract(from:)` has one code path (metadata only)
- No `contains("<available_skills>")` guard in session creation
- No `reserveCapacity` in skills code
- `swift build` succeeds
- `swift test` passes
