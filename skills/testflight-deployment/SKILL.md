---
name: testflight-deployment
description: |
  Build and upload the Wuhu iOS app to TestFlight. Covers xcodegen project
  generation, archiving, exporting with API key auth, and uploading via
  altool. Use this when the user asks to submit a build to TestFlight.
---

# TestFlight Deployment

## Quick path

From the `wuhu-app` directory:

```bash
cd wuhu-app
./scripts/build-testflight.sh
```

The script handles xcodegen → archive → export → upload. Use `--skip-gen`
to skip xcodegen if the project is already generated. Use `--no-upload` to
export the IPA without uploading.

After upload, monitor processing:

```bash
./scripts/check-testflight.sh        # one-shot
./scripts/check-testflight.sh --watch # poll every 30s
```

## Version & build numbers

### Auto-management (how it works now)

The export options plist has `manageAppVersionAndBuildNumber: true` (the
default). During `xcodebuild -exportArchive`, Xcode queries App Store
Connect for the highest build number for the app's marketing version, then
stamps `max(archive_build, asc_highest + 1)` into the exported IPA.

**You do not need to manually bump the build number for TestFlight.**
The value in `project.yml` (`CURRENT_PROJECT_VERSION`) is just a floor —
if ASC already has a higher number, Xcode auto-bumps past it.

### Where version is defined

- **Source of truth**: `wuhu-app/WuhuApp/project.yml` (xcodegen)
- **Build settings** (project-level):
  - `MARKETING_VERSION` — the user-facing version (e.g., `"1.0"`)
  - `CURRENT_PROJECT_VERSION` — the build number floor (e.g., `"15"`)
- **Info.plist** references these via `$(MARKETING_VERSION)` and
  `$(CURRENT_PROJECT_VERSION)`. The plists are generated by xcodegen and
  gitignored — don't edit them directly.

### When to bump manually

- **Marketing version**: Bump `MARKETING_VERSION` for a new release
  (e.g., `1.0` → `1.1`). This resets the ASC build number sequence.
- **Build number**: Only bump `CURRENT_PROJECT_VERSION` if you want the
  Xcode UI to display a meaningful number during development. For TestFlight
  it's handled automatically.

## Authentication

The build script uses an App Store Connect API key for both export signing
and upload. The key lives at:

```
~/.appstoreconnect/private_keys/AuthKey_3U39ZA4G2A.p8
```

The export step passes `-authenticationKeyPath`, `-authenticationKeyID`,
and `-authenticationKeyIssuerID` to `xcodebuild -exportArchive`. This
avoids requiring an Apple account logged into Xcode.

The upload step uses `xcrun altool --upload-app` with the same API key
(`--apiKey` and `--apiIssuer`).

### "Failed to Use Accounts" error

If you see this during export, it means the export options used
`destination: upload` without API key auth flags. The fix is to use
`destination: export` with the `-authentication*` flags, then let altool
handle the upload separately. The current script already does this.

## Export options explained

Key fields in the `ExportOptions.plist`:

| Key | Value | Why |
|-----|-------|-----|
| `method` | `app-store-connect` | Required for TestFlight/App Store |
| `destination` | `export` | Produces an IPA locally (not `upload` which needs Xcode account auth) |
| `teamID` | `97W7A3Y9GD` | The Apple Developer team |
| `manageAppVersionAndBuildNumber` | `true` (default) | Auto-bumps build number from ASC |

## Verifying the exported build

After export, check what Xcode actually stamped:

```bash
cat wuhu-app/build/Export/DistributionSummary.plist
```

Look for `buildNumber` and `versionNumber` — these are what ASC receives,
and may differ from your project settings due to auto-management.

## Typical upload timeline

1. `altool` upload: ~5 seconds (the IPA is ~13 MB)
2. ASC processing: 1–5 minutes
3. Build appears in `check-testflight.sh` as `PROCESSING`, then `VALID`
4. TestFlight app on device picks it up within minutes of `VALID`

## Troubleshooting

- **Build not appearing on TestFlight**: Check `check-testflight.sh`. If
  the build is `VALID` but not on device, the tester group may need to be
  assigned in ASC, or the device needs to refresh TestFlight.
- **Upload succeeds but build never appears**: The build number may have
  been lower than an existing build. ASC silently drops duplicates/lower
  builds. Check `DistributionSummary.plist` to see the actual stamped
  number.
- **Provisioning errors during archive**: Run `xcodegen generate` first.
  The `.xcodeproj` is gitignored and must be regenerated.
